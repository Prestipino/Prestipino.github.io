<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- SEO & Page Info -->
    <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>
    {% if page.description %}
    <meta name="description" content="{{ page.description }}">
    {% elsif site.description %}
    <meta name="description" content="{{ site.description }}">
    {% endif %}
    
    <!-- 1. LOAD YOUR CUSTOM CSS FIRST -->
    <link rel="stylesheet" href="{{ '/assets/css/custom.css' | relative_url }}">

    <!-- 2. Optionally load theme CSS ONLY if you need it -->
    <!-- <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}"> -->
</head>
<body>
    <!-- HEADER BAR -->
    <header class="site-header">
        <div class="wrapper">
            <a class="site-title" href="{{ '/' | relative_url }}">{{ site.title | default: site.github.repository_name }}</a>
            
            <nav class="site-nav">
                <input type="checkbox" id="nav-trigger" class="nav-trigger" />
                <label for="nav-trigger">
                    <span class="menu-icon">☰</span>
                </label>
                
                <div class="trigger">
                    {% for item in site.navigation %}
                    <a class="page-link" href="{{ item.link | relative_url }}">{{ item.name }}</a>
                    {% endfor %}
                </div>
            </nav>
        </div>
    </header>

    <div class="page-content">
        <div class="wrapper">
            <!-- SIDEBAR -->
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    {% for section in site.data.sidebar.sections %}
                    <div class="sidebar-section">
                        <h3>{{ section.title }}</h3>
                        <ul>
                            {% for link in section.links %}
                            <li>
                                <a href="{{ link.url | relative_url }}"
                                   {% if link.new_window %}target="_blank" rel="noopener noreferrer"{% endif %}>
                                   {% if link.icon %}{{ link.icon }}{% endif %}
                                   {{ link.name }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endfor %}
                </nav>
            </aside>
            
            <!-- MAIN CONTENT -->
            <main class="main-content">
                {% if page.toc %}
                <div class="page-toc">
                    <h3>Page Contents</h3>
                    {% include toc.html %}
                </div>
                {% endif %}

                {{ content }}
            </main>
        </div>
    </div>

    <footer class="site-footer">
        <div class="wrapper">
            <p>Hosted on GitHub Pages — Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
        </div>
    </footer>
    <!-- Automatic Table of Contents Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Only run on pages that should have a TOC
        if (!document.querySelector('.main-content')) return;

        // Find all h2 and h3 headings in the main content
        const headings = document.querySelectorAll('.main-content h2, .main-content h3');
        if (headings.length < 2) return; // Don't create TOC for pages with few sections

        // Create the TOC container
        const tocContainer = document.createElement('div');
        tocContainer.className = 'page-toc';

        // Create TOC title
        const tocTitle = document.createElement('h3');
        tocTitle.textContent = 'Page Contents';
        tocContainer.appendChild(tocTitle);

        // Create the list
        const tocList = document.createElement('ul');
        tocList.className = 'toc-list';

        // Track hierarchy for nested lists
        let currentH2Item = null;
        let currentH2List = null;

        // Store references to heading IDs and their links for highlighting
        const headingMap = new Map();

        headings.forEach((heading, index) => {
            // Create ID for heading if it doesn't have one
            if (!heading.id) {
                // Create a URL-friendly ID from the text
                heading.id = 'section-' + heading.textContent
                    .toLowerCase()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/--+/g, '-')
                    .replace(/^-+/, '')
                    .replace(/-+$/, '');

                // Add index if there are duplicates
                if (document.getElementById(heading.id)) {
                    heading.id = heading.id + '-' + index;
                }
            }

            // Create list item
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = '#' + heading.id;
            link.textContent = heading.textContent;

            // Store mapping for highlighting
            headingMap.set(heading.id, link);

            // Add classes based on heading level
            if (heading.tagName === 'H2') {
                listItem.className = 'toc-h2';
                tocList.appendChild(listItem);
                currentH2Item = listItem;
                currentH2List = null;
            } else if (heading.tagName === 'H3') {
                listItem.className = 'toc-h3';

                // Create nested list for h3 under h2
                if (currentH2Item && !currentH2List) {
                    currentH2List = document.createElement('ul');
                    currentH2List.className = 'toc-sublist';
                    currentH2Item.appendChild(currentH2List);
                }

                if (currentH2List) {
                    currentH2List.appendChild(listItem);
                } else {
                    tocList.appendChild(listItem);
                }
            }

            listItem.appendChild(link);

            // Add smooth scrolling
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.getElementById(heading.id);
                if (target) {
                    // Remove active class from all links
                    document.querySelectorAll('.page-toc a').forEach(link => {
                        link.classList.remove('active');
                    });
                    // Add active class to clicked link
                    link.classList.add('active');

                    window.scrollTo({
                        top: target.offsetTop - 100,
                        behavior: 'smooth'
                    });
                }
            });
        });

        tocContainer.appendChild(tocList);

        // Insert TOC at the beginning of the main content
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
            mainContent.insertBefore(tocContainer, mainContent.firstChild);
        }

        // ===== ACTIVE SECTION HIGHLIGHTING =====

        // Highlight first section by default
        if (headings.length > 0) {
            const firstLink = headingMap.get(headings[0].id);
            if (firstLink) firstLink.classList.add('active');
        }

        // Create intersection observer for scroll highlighting
        const observerOptions = {
            root: null, // Use the viewport
            rootMargin: '-100px 0px -66% 0px', // Adjust when sections become "active"
            threshold: 0 // Trigger as soon as any part is visible
        };

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                const id = entry.target.id;
                const tocLink = headingMap.get(id);

                if (entry.isIntersecting) {
                    // Remove active class from all links
                    document.querySelectorAll('.page-toc a').forEach(link => {
                        link.classList.remove('active');
                    });

                    // Add active class to current link
                    if (tocLink) {
                        tocLink.classList.add('active');

                        // Optional: Update URL hash without scrolling
                        if (history.pushState) {
                            history.pushState(null, null, '#' + id);
                        }
                    }
                }
            });
        }, observerOptions);

        // Observe each heading
        headings.forEach(heading => {
            observer.observe(heading);
        });

        // Handle direct URL hash (e.g., someone shares a link with #section-id)
        function highlightFromHash() {
            const hash = window.location.hash.substring(1);
            if (hash && headingMap.has(hash)) {
                document.querySelectorAll('.page-toc a').forEach(link => {
                    link.classList.remove('active');
                });
                headingMap.get(hash).classList.add('active');
            }
        }

        // Check hash on page load
        highlightFromHash();

        // Update when hash changes (browser back/forward buttons)
        window.addEventListener('hashchange', highlightFromHash);

        // ===== RESPONSIVE BEHAVIOR =====

        // Optional: Move TOC to sidebar on wide screens
        function moveTocForWideScreens() {
            if (window.innerWidth >= 1200 && document.querySelector('.sidebar')) {
                const sidebar = document.querySelector('.sidebar');
                const existingToc = sidebar.querySelector('.page-toc');

                // Only move if not already in sidebar
                if (!existingToc && tocContainer.parentElement === mainContent) {
                    sidebar.appendChild(tocContainer);
                    tocContainer.classList.add('toc-in-sidebar');
                }
            } else {
                // Move back to main content if screen is narrow
                const sidebarToc = document.querySelector('.sidebar .page-toc');
                if (sidebarToc && mainContent) {
                    mainContent.insertBefore(sidebarToc, mainContent.firstChild);
                    sidebarToc.classList.remove('toc-in-sidebar');
                }
            }
        }

        // Check on load and resize
        moveTocForWideScreens();
        window.addEventListener('resize', moveTocForWideScreens);
    });
    </script>
</body>
</html>