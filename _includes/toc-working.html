<nav class="toc-nav">
  {% comment %} FINAL WORKING TOC {% endcomment %}
  
  <ul class="toc-list">
    {% comment %} 
    Extract ALL h2 headings from content 
    This is the reliable method
    {% endcomment %}
    
    {% comment %} First, get a clean version of content {% endcomment %}
    {% assign clean_content = content | strip_html | strip %}
    
    {% comment %} Split by h2 tags {% endcomment %}
    {% assign h2_parts = content | split: '<h2' %}
    
    {% for part in h2_parts %}
      {% if part contains 'id=' %}
        {% comment %} Extract ID {% endcomment %}
        {% assign id_start = part | split: 'id="' | last %}
        {% assign id = id_start | split: '"' | first %}
        
        {% comment %} Extract TITLE (text between > and </h2) {% endcomment %}
        {% assign after_gt = part | split: '>' %}
        {% if after_gt.size > 1 %}
          {% assign possible_title = after_gt | last %}
          {% assign title_parts = possible_title | split: '</h2' %}
          {% if title_parts.size > 0 %}
            {% assign title = title_parts[0] | strip %}
            
            <li class="toc-h2">
              <a href="#{{ id }}">{{ title }}</a>
            </li>
            
            {% comment %} Check for h3 under this h2 {% endcomment %}
            {% assign h3_check = part | split: '<h3' %}
            {% if h3_check.size > 1 %}
              {% for h3part in h3_check %}
                {% if h3part contains 'id=' and forloop.index0 > 0 %}
                  {% assign h3_id_start = h3part | split: 'id="' | last %}
                  {% assign h3_id = h3_id_start | split: '"' | first %}
                  
                  {% assign h3_after_gt = h3part | split: '>' %}
                  {% if h3_after_gt.size > 1 %}
                    {% assign h3_possible = h3_after_gt | last %}
                    {% assign h3_title_parts = h3_possible | split: '</h3' %}
                    {% if h3_title_parts.size > 0 %}
                      {% assign h3_title = h3_title_parts[0] | strip %}
                      
                      <li class="toc-h3">
                        <a href="#{{ h3_id }}">{{ h3_title }}</a>
                      </li>
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}
            
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  </ul>
  
  {% comment %} Simple debug {% endcomment %}
  <div style="background: #f5f5f5; padding: 5px; margin-top: 10px; font-size: 11px; color: #666;">
    Found {{ h2_parts | size | minus: 1 }} heading(s)
  </div>
</nav>
